
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>In Which We Build Zeus - Mnemnion</title>
  <meta name="author" content="Sam Atman">

  
  <meta name="description" content="Athena is our weaver. This is her source file. As we are writing a weaver, it happens that we do not have one. This file must perforce be hand woven &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mnemnion.github.io/blog/2013/08/04/in-which-we-build-zeus">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Mnemnion" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Mnemnion</a></h1>
  
    <h2>A Unit of Analogy</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mnemnion.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">In Which We Build Zeus</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-04T18:59:00-07:00" pubdate data-updated="true">Aug 4<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Athena is our weaver. This is her source file. </p>

<p>As we are writing a weaver, it happens that we do not have one. This file must perforce be hand woven until Athena may take over. Asking a Goddess to take over any process should not, and shall not, be done casually. </p>

<p>Athena is written in <a href="https://help.github.com/articles/github-flavored-markdown">Git Flavored Markdown</a>, a format designed around code sharing. The executable parts are written in <a href="http://clojure.org">Clojure</a>, using the <a href="https://github.com/Engelberg/instaparse">Instaparse</a> parsing library. </p>

<h1 id="toc_8">Hymn</h1>

<p>Hail, fleet footed Hermes, beloved of Athena!</p>

<p>Hail, Pallas Athene! Hear the ancient words:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>I begin to sing of Pallas Athena, the glorious Goddess, bright-eyed,  
</span><span class='line'>inventive, unbending of heart,  
</span><span class='line'>pure virgin, saviour of cities,  
</span><span class='line'>courageous, Tritogeneia. Wise Zeus himself bare her  
</span><span class='line'>from his awful head, arrayed in warlike arms  
</span><span class='line'>of flashing gold, and awe seized all the gods as they gazed.  
</span><span class='line'>But Athena sprang quickly from the immortal head 
</span><span class='line'>and stood before Zeus who holds the aegis,  
</span><span class='line'>shaking a sharp spear: great Olympus began to reel horribly 
</span><span class='line'>at the might of the bright-eyed Goddess, 
</span><span class='line'>and earth round about cried fearfully,  
</span><span class='line'>and the sea was moved and tossed with dark waves,  
</span><span class='line'>while foam burst forth suddenly:  
</span><span class='line'>the bright Son of Hyperion stopped his swift-footed horses a long while, 
</span><span class='line'>      until the maiden Pallas Athena had stripped the heavenly armour 
</span><span class='line'>      from her immortal shoulders.  
</span><span class='line'>And wise Zeus was glad. </span></code></pre></td></tr></table></div></figure>

<p>And so hail to you, daughter of Zeus who holds the aegis!<br><br>
Now I will remember you and another song as well.  </p>

<h2 id="toc_9">Bootstrap</h2>

<p>To bootstrap Athena, we write a restricted program. It does not weave, so much as extract and concatenate code.</p>

<p>We then write more Markdown that specifies a macro format, also in this restricted format. We use our first weaver to weave both generations of the project into Athena, which will then be more broadly useful. </p>

<p>This first weaver will be known as zeus. zeus is, of course, that from which Athena will spring full-born. </p>

<p>Clojure projects are typically generated with <a href="https://github.com/technomancy/leiningen">Leiningen</a>, and Athena is no exception. Leiningen projects are specified in a root directory file called <code>project.clj</code>. </p>

<p>This is project.clj:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">athena</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;Athena: a Weaver of Code&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://github.com/mnemnion/marmion/athena&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;BSD 2-Clause License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://http://opensource.org/licenses/BSD-2-Clause&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.4.0&quot;</span><span class="p">]])</span>
</span></code></pre></td></tr></table></div></figure>

<p>In order to weave code, in general, we need a macro format. This may be made as flexible as necessary. The minimal requirement is the ability to specify a macro name, and expand those macros into files. </p>

<p>This is weaving in its essence.</p>

<p>The above code contains no macro, yet. Writing macros in a Lisp is of course pleasurable and powerful, and Clojure is no exception, having definable <a href="http://clojure.org/reader">reader macros</a>. Soon, we will define one.</p>

<p>First, however, we need a parser that can extract our code. For that, we need to add <a href="https://github.com/Engelberg/instaparse">Instaparse</a>.</p>

<p>Time to fire up <a href="https://github.com/bodil/catnip">Catnip</a> real quick. Be back soon!</p>

<p>What we&#39;re doing next is adding Instaparse to our project. To do this, we have to tell Leiningen to grab Instaparse, which we must do from the config file. This is normally found at <code>~/.lein/profiles.clj</code>; if it&#39;s not, I hope you know what you&#39;re doing. We add the string <code>[instaparse &quot;1.2.2&quot;]</code> to the <code>:plugins</code> vector.</p>

<p>That done, start or restart your project in Catnip, <a href="http://emacs.org">Emacs</a>, or however you like to do it. You must launch with <code>lein</code>, which is totally conventional.</p>

<p>This being a bootstrap, we will need to resort to some custom syntax in our Markdown. As we extract the source, we will encounter various <code>@magic words@</code>, which the parser will do various things with. The ones in this paragraph, for example, it will ignore. The recognition sequence is <code>`@</code> to begin a magic word, and <code>@`</code> to end one. </p>

<p>These aren&#39;t macros. As you can see, they remain in the source code, and don&#39;t modify it.</p>

<p>Adding <code>[instaparse &quot;1.2.2&quot;]</code> to our project.clj gives us this:</p>

<p><code>@/marmion/athena/project.clj@</code> &#8211;&gt; where we find it, natch</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">athena</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;Athena: a Weaver of Code&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://github.com/mnemnion/marmion/athena&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;BSD 2-Clause License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://http://opensource.org/licenses/BSD-2-Clause&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.4.0&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">instaparse</span> <span class="s">&quot;1.2.2&quot;</span><span class="p">]])</span>
</span></code></pre></td></tr></table></div></figure>

<p>Which should compile. </p>

<p>Lein provides us with the following template in <code>@/marmion/athena/src/athena/core.clj@</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">athena.core</span>
</span><span class='line'>    <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">instaparse.core</span> <span class="ss">:as</span> <span class="nv">insta</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">foo</span>
</span><span class='line'>  <span class="s">&quot;I don&#39;t do a whole lot.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">x</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">println </span><span class="nv">x</span> <span class="s">&quot;Hello, World!&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>

<p>We added instaparse.core there. This should compile too. </p>

<p>We now have a powerful and general [GLL] parser at our disposal. Yippie!</p>

<p>Let&#39;s do something with it!</p>

<p>How about we open up our source file, <code>athena.md</code>, and see if we can produce a quine of our existing file and directory structure?</p>

<p>Leiningen provides us with a test, <code>@/marmion/athena/src/athena/core_test.clj@</code>. It begins life looking like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">athena.core-test</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:use</span> <span class="nv">clojure.test</span>
</span><span class='line'>        <span class="nv">athena.core</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">deftest</span> <span class="nv">a-test</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">testing</span> <span class="s">&quot;FIXME, I fail.&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nb">= </span><span class="mi">0</span> <span class="mi">1</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>

<p>We will leave it alone for now. Eventually, we will want to test our quine against the code as it was written. </p>

<p>For the same reason, we will leave the function <code>foo</code> in the namespace. Nothing will be deleted or modified, and the order in which code is introduced is the order into which it will be woven. This is a bootstrap, after all. </p>

<p>Instaparse has its own format, which could be specified as a string within the .clj file. We prefer to put the grammar in its own file, <code>@/marmion/athena/zeus.grammar@</code>, which we start like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>(* A Grammar for Zeus, Father of Athena, A Literate Weaver *)
</span></code></pre></td></tr></table></div></figure>

<p>Our first rule is top level. The markdown may be separated into that which is kept, that which is ignored, and that which is magic.</p>

<p>In Instaparse, that looks something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>zeus-program = (magic | code | &lt;markdown&gt;) *
</span></code></pre></td></tr></table></div></figure>

<p>What this says is that a zeus program is any combination of magic, code, and markdown. Since Zeus does nothing with the markdown, we use angle brackets to tell Instaparse that we don&#39;t care to see the output. </p>

<p>We&#39;ll define code next:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>code =  &lt;&quot;`&quot; &quot;`&quot; &quot;`&quot;&gt; code-type code-block+ &lt;&quot;`&quot; &quot;`&quot; &quot;`&quot;&gt;
</span><span class='line'>   | &lt;&quot;`&quot; &quot;`&quot; &quot;`&quot;&gt; &quot;\n&quot; code-block+ &lt;&quot;`&quot; &quot;`&quot; &quot;`&quot;&gt;
</span><span class='line'>   ;
</span><span class='line'>
</span><span class='line'>code-type = &quot;clojure&quot; | &quot;text&quot; ;
</span><span class='line'>
</span><span class='line'>&lt;code-block&gt; = #&#39;[^`]+&#39; | in-line-code ;
</span><span class='line'>
</span><span class='line'>&lt;in-line-code&gt; = !(&quot;`&quot; &quot;`&quot; &quot;`&quot;) (&quot;`&quot;|&quot;``&quot;);
</span></code></pre></td></tr></table></div></figure>

<p>Which will suffice to capture our quine. </p>

<p>Please note: we could use a more direct way to capture three <code>`</code>, if we weren&#39;t writing a peculiar quine. Zeus uses the simplest possible grammar to extract a minimalist weaver from this very source file. </p>

<p>A couple notes: <code>code-block</code> is mostly a regular expression that doesn&#39;t consume backticks. <code>in-line-code</code> uses negative lookahead <code>!</code>, which is great stuff: it says, if there aren&#39;t three backticks ahead of us, you may match one or two of those backticks. </p>

<p>Between them, they match everything except three backticks. Real Markdown uses newlines and triple backticks together. This is harder to write and understand, so we&#39;ll do it in the second pass.</p>

<p>We also need magic:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&lt;magic&gt; = &lt;&quot;`@&quot;&gt; magic-word &lt;&quot;@`&quot;&gt; ;
</span><span class='line'>
</span><span class='line'>magic-word = #&#39;[^@]+&#39; ;
</span></code></pre></td></tr></table></div></figure>

<p>Which is defined fairly carefully to consume our magic words. We don&#39;t use the at-sign elsewhere in the outer Markdown to enable easy magic.</p>

<p>That leaves <code>markdown</code> which is perhaps not strictly named, since the code blocks are markdown also. For Zeus, we may as well call it junk; we have to match it, but we don&#39;t look at it. It looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>markdown = #&#39;[^`@]+&#39; | in-line-code;
</span></code></pre></td></tr></table></div></figure>

<p>We&#39;re done! We now have a grammar that we can make into a parser, so let&#39;s do it: we need to add more code to <code>@/marmion/athena/src/athena/core.clj@</code>. </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">zeus-parser</span> <span class="p">(</span><span class="nf">insta/parser</span> <span class="p">(</span><span class="nb">slurp </span><span class="s">&quot;zeus.grammar&quot;</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>

<p>That was simple enough. It disguises the toil of repeatedly writing bad, useless and exponentially explosive grammars.</p>

<p>But then, literature generally hides the messiness behind its production. If you have read the unedited <em>Stranger in a Strange Land</em>, which Heinlein never wanted published, you can see why. Presuming you&#39;ve read the edited version. </p>

<p>Now, we use <code>zeus-parser</code> to parse this document, <code>athena.md</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">parsed-athena</span> <span class="p">(</span><span class="nf">zeus-parser</span> <span class="p">(</span><span class="nb">slurp </span><span class="s">&quot;athena.md&quot;</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>

<p>When we run <code>core.clj</code> in a REPL, we see that <code>parsed-athena</code> is a tree-structure containing our magic words and code. We&#39;ve designed this puzzle so that we can use this sorted information in the order we found it, so we don&#39;t need the tree structure.</p>

<p>To simply get rid of the tree structure we would <code>flatten</code> it. But this would leave us in a bad way, because some of our code blocks aren&#39;t globbed into a single string, thanks to separate detection for <code>` `</code> [sic] and <code>`</code>. </p>

<p>Fortunately, this is so common that Instaparse ships with a function for fixing it. <code>insta/transform</code> to the rescue!</p>

<p>First we need a helper function for insta/transform to call:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">cat-code</span> <span class="s">&quot;a bit of help for code blocks&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">tag</span> <span class="o">&amp;</span> <span class="nv">body</span><span class="p">]</span> <span class="p">(</span><span class="nf">vec</span> <span class="p">[</span><span class="nv">tag</span> <span class="p">(</span><span class="nb">apply str </span><span class="nv">body</span><span class="p">)]))</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then we call it and do some stuff to the results:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">flat-athena</span> <span class="p">(</span><span class="nb">drop </span><span class="mi">10</span> <span class="p">(</span><span class="nf">flatten</span> <span class="p">(</span><span class="nf">insta/transform</span> <span class="p">{</span><span class="ss">:code</span> <span class="nv">cat-code</span><span class="p">}</span> <span class="nv">parsed-athena</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now, how you feel about this line depends on how you feel about Lisp, generally. This was written progressively from the middle out, on a REPL. It&#39;s easy to read if you know that, and would be easier still if formatted more naturally. </p>

<p>A more idiomatic Clojure way to do all this would be to use a threading macro like <code>-&gt;&gt;</code> to thread the data structure through the transformations, instead of making all these global defs. Everything so far could be a single function, though it&#39;s sensible to put the parser in its own ref.</p>

<p><code>drop 10</code> just gets us past the front matter. We introduce our idioms before we use them, for a reason.</p>

<p>We now have a flat vector, containing all the information we need. We need to transform it into a data structure which may then be massaged and spat out as our original project and core files. </p>

<p>The quine could be completed with a trivial act, which we put in the margins: <code>(spit athene-as-is.md (remove-tags-flatten-and-concatenate (zeus-parser (slurp athena.md) :unhide :all)))</code>, which calls a function we needn&#39;t bother to write. All this does is parse athena.md, remove the tags, flatten the remaining literal values, which, because we used <code>:unhide :all</code>, was everything from our original source file. Cute, but not interesting enough to belong in the quine. Opening your source file, doing nothing interesting to it, and saving/printing it is generally a trivial quine, though if the convolutions you put the text through are hard enough to follow you will amuse someone at least.</p>

<p>Instead, let&#39;s write a little helper function, <code>key-maker</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">key-maker</span>
</span><span class='line'>  <span class="s">&quot;makes a keyword name from our file string&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">file-name</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">keyword </span> <span class="p">(</span><span class="nb">last </span><span class="p">(</span><span class="nf">clojure.string/split</span> <span class="nv">file-name</span> <span class="o">#</span><span class="s">&quot;/&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>

<p>This takes our fully-qualified filename, pulled from a magic word, and keywordizes it. The magic words are arranged so there&#39;s one each time zeus needs to change files.</p>

<p>Now for the meat of the matter. <code>weave-zeus</code> produces the source file to zeus from the markdown version of this very file. </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">weave-zeus</span>
</span><span class='line'>  <span class="s">&quot;a weaver to generate our next iteration&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">state</span> <span class="nv">code</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">keyword? </span><span class="p">(</span><span class="nb">first </span><span class="nv">code</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="ss">:magic-word</span> <span class="p">(</span><span class="nb">first </span><span class="nv">code</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">weave-zeus</span> <span class="p">(</span><span class="nb">assoc </span><span class="nv">state</span>
</span><span class='line'>                             <span class="ss">:current-file</span>, <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">rest </span><span class="nv">code</span><span class="p">)))</span>
</span><span class='line'>                      <span class="p">(</span><span class="nb">drop </span><span class="mi">2</span> <span class="nv">code</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">file-key</span> <span class="p">(</span><span class="nf">key-maker</span> <span class="p">(</span><span class="ss">:current-file</span> <span class="nv">state</span><span class="p">))]</span>
</span><span class='line'>              <span class="p">(</span><span class="nf">weave-zeus</span> <span class="p">(</span><span class="nb">assoc </span><span class="nv">state</span>
</span><span class='line'>                                 <span class="nv">file-key</span>,
</span><span class='line'>                                 <span class="p">(</span><span class="nb">apply str </span><span class="p">(</span><span class="nf">state</span> <span class="nv">file-key</span><span class="p">)</span> <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">rest </span><span class="p">(</span><span class="nb">rest </span><span class="nv">code</span><span class="p">)))))</span>
</span><span class='line'>                          <span class="p">(</span><span class="nb">drop </span><span class="mi">3</span> <span class="nv">code</span><span class="p">))))</span>
</span><span class='line'>      <span class="nv">state</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now, that&#39;s a hack. It&#39;s a bootstrap; I fiddled with it until it worked. It is perhaps more readable than a more elegant version, if you have, like most of us, a background or ongoing investment in imperative style. The principle is ruthless pruning and minimal intelligence. We aren&#39;t touching it further, though we use it as a spring-off point for migraine, the next step in the process.</p>

<p>Migraine because it actually gives birth to Athena. Named in honor of whichever poor sufferer dreamed that mythos up. </p>

<p>So we move the latest athena.md into the project directory, load up the REPL and sure enough, it&#39;s all in there. Now we just have to <code>spit</code> it out. To do it right, we&#39;d have kept some exact record of our file name so we could put it into a new directory of the same form. We&#39;re going to cheat instead; we did the hard part, and want to keep it readable since we don&#39;t have macros with which to bury the boring parts.</p>

<p>So here&#39;s our last trick:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">zeus-map</span> <span class="p">(</span><span class="nf">weave-zeus</span> <span class="p">{}</span> <span class="nv">flat-athena</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">spit</span> <span class="s">&quot;migraine/zeus.grammar&quot;</span>  <span class="p">(</span><span class="ss">:zeus.grammar</span> <span class="nv">zeus-map</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">spit</span> <span class="s">&quot;migraine/core-test.clj&quot;</span> <span class="p">(</span><span class="ss">:core_test.clj</span> <span class="nv">zeus-map</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">spit</span> <span class="s">&quot;migraine/core.clj&quot;</span>      <span class="p">(</span><span class="ss">:core.clj</span> <span class="nv">zeus-map</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>

<p>That&#39;s it! The structure of the migraine directory is flat, not the structure leiningen requires, and there are some extra newlines in the source, but I don&#39;t care and neither should you. It&#39;s officially close enough for government work. In our next chapter, we will undergo the formality of writing a test and demonstrating that Migraine&#39;s markdown contains Athena alpha, which will be a part of Athena herself. </p>

<p>Migraine, the next chapter in this adventure, will add some actual capabilities. Migraine is just Zeus with an extra headache: instead of producing himself, he has to produce Athena, which is a more challenging software to write.   </p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Sam Atman</span></span>

      








  


<time datetime="2013-08-04T18:59:00-07:00" pubdate data-updated="true">Aug 4<span>th</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mnemnion.github.io/blog/2013/08/04/in-which-we-build-zeus/" data-via="" data-counturl="http://mnemnion.github.io/blog/2013/08/04/in-which-we-build-zeus/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/08/04/progressive-refinement-in-gll/" title="Previous Post: Progressive Refinement in GLL">&laquo; Progressive Refinement in GLL</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/09/04/why-i-am-lisp-2/" title="Next Post: Why I Am Lisp 2">Why I Am Lisp 2 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/10/05/the-urbit-has-landed/">The Urbit Has Landed</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/01/on-decimation/">On Decimation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/11/a-parenthetical-observation/">A Parenthetical Observation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/04/why-i-am-lisp-2/">Why I Am Lisp 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/04/in-which-we-build-zeus/">In Which We Build Zeus</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mnemnion">@mnemnion</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mnemnion',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Sam Atman -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
